---
title: "Seleção do período de análise dados das EMAs do INMET"
author: "Jonas Corrêa (graduando) e Jônatan Tatsch (orientador)"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_notebook:
    toc: yes
  html_document:
    fig_caption: yes
    fig_width: 6
    keep_md: yes
    number_sections: yes
    toc: yes
---
# PARTE 0

## Definições dos dados salvos:

+ data_raw (dados brutos): *s01_data_raw.rds*
 
+ data_ren (dados renomeados): *s02_data_ren.rds*
 
+ data_mod (add médias): *s03_data_mod.rds*
 
+ data_pad (add completamento de datas): *s04_data_pad.rds*

+ data_var (seleção das variáveis que serão usadas): *s05_data_var.rds*

+ data_inf (filtro de EMAs não informativas): *s06_data_inform.rds*

+ data_year (seleção do ano inicial e final para análise): *s07_data_year.rds*

+ data_sel (seleção das EMAs com no mínimo 4 anos de dados): *s08_data_sel.rds*

# PARTE 1

## Introdução

A definição do período para análise das séries de dados de uma rede de estações meteorológicas automáticas (EMAs) segue critérios baseados na homogeneidade espacial das EMAs, na quantidade de dados mínima. Como critério inicial serão selecionadas estações meteorológicas automáticas (EMA) com pelo menos 4 anos de dados (podem ser descontínuos).

As etapas para seleção do período são:

- regularizar as séries temporais de cada EMA para garantir que todas tenham 24 h em cada dia e 365 (ou 366 dias, se ano bissexto) em cada ano

- determinar o período de dados de cada EMA (n° de anos)

- quantificar o número de dados válidos (não faltantes) para cada EMA

## Pacotes, funções e pré-configurações

```{r}
# Limpa o espaço de trabalho
rm(list = ls())
```

```{r setup, message=FALSE}
# Carrega pacotes necessários
packs <- c("dplyr", "knitr", "lubridate", "magrittr", "openair", "padr", "stringr", "tidyverse")
easypackages::libraries(packs)
rm(packs)

# Carrega scripts necessários
source('/home/jonas/Documents/GITHUB/jbc-ic/R/complete_dates.R')
source('/home/jonas/Documents/GITHUB/jbc-ic/R/gaps.R')
source('/home/jonas/Documents/GITHUB/jbc-ic/R/gg_bubble.R')
source('/home/jonas/Documents/GITHUB/jbc-ic/R/utils.R')
```

Os dados são armazenados usando o Tempo Universal Coordenado [UTC](https://pt.wikipedia.org/wiki/Tempo_Universal_Coordenado). Portanto, podemos definir esse horário como padrão nessa sessão do R. Assim qualquer conversão ou operação com datas e horários usando objetos [POSIX](https://stat.ethz.ch/R-manual/R-devel/library/base/html/DateTimeClasses.html) serão realizadas em UTC.

```{r}
# Definindo globalmente tz = "UTC"
Sys.setenv(TZ = "UTC")
```

## Dados brutos

### Informações das EMAs (metadados)

Informações como as coordenadas de localização, altitude, nome e código das EMAs foram extraídas do cabeçalho contido no arquivo excel com os dados de cada EMA. Entretanto, notou-se que em alguns casos houve erro de digitação das coordenadas quando comparadas aquelas disponíveis no site do INMET.

```{r}
# Metadados do INMET corrigidos e atualizados.(see R/aws-inmet-metadata.R)
info <- readRDS('/home/jonas/Documents/GITHUB/jbc-ic/data/info-inmet-sul.rds') %>%
  arrange(state, site) %>%
  select(site:alt) #retirada da coluna "start"
info

## Foi adicionada a estação de Goiore (A825)
```

### Dados meteorológicos

```{#r}
# Carregar os dados meteorológicos brutos das EMA
data_raw <- readRDS('/home/jonas/Documents/GITHUB/jbc-ic/data/data-raw-inmet-sul-20000922-20161231.rds') %>% arrange(site)

# Nova variável que será renomeada
data_ren <- data_raw %>% arrange(site)

# Renomeando as variáveis 'tair' e 'td' da nova variável
n1 <- which(names(data_ren) == 'tair')
names(data_ren) [n1] <- 'tinst'
n2 <- which(names(data_ren) == 'td')
names(data_ren) [n2] <- 'tdinst'
rm(n1, n2)

data_ren
```

```{#r save_s01_s02}
saveRDS(data_raw, '/home/jonas/Documents/GITHUB/jbc-ic/data_saves/s01_data_raw.rds')
saveRDS(data_ren, '/home/jonas/Documents/GITHUB/jbc-ic/data_saves/s02_data_ren.rds')

rm(data_raw, data_ren)
```

```{r load_s01}
data_raw <- readRDS('/home/jonas/Documents/GITHUB/jbc-ic/data_saves/s01_data_raw.rds')
data_raw
```

```{r load_s02}
data_ren <- readRDS('/home/jonas/Documents/GITHUB/jbc-ic/data_saves/s02_data_ren.rds')
data_ren
```

```{#r}
# Adicionando as colunas para "tavg", "tdavg", "rhavg" e "pavg"
data_mod <-
  data_ren %>% 
  mutate(
    tavg = (tmax + tmin) / 2,
    tdavg = (tdmax + tdmin) / 2,
    rhavg = (rhmax + rhmin) / 2,
    pavg = (pmax + pmin) / 2) %>% 
  select(
    site, date,
    tinst, tmin, tavg, tmax,
    tdinst, tdmin, tdavg, tdmax,
    rh, rhmin, rhavg , rhmax,
    p, pmin, pavg , pmax,
    everything() )
data_mod

rm(data_ren)
```

```{#r save_s03}
saveRDS(data_mod, '/home/jonas/Documents/GITHUB/jbc-ic/data_saves/s03_data_mod.rds')

rm(data_mod)
```

```{r load_s03}
data_mod <- readRDS('/home/jonas/Documents/GITHUB/jbc-ic/data_saves/s03_data_mod.rds')
data_mod
```

```{#r summary_mod}
temp.summary(
  DATA = data_mod,
  INFO = info,
  TYPE = "MOD",
  HOUSES = 5,
  SAVE = T,
  DIRECTORY = '/home/jonas/Documents/GITHUB/jbc-ic/data_saves/summary_mod.rds'
)
```

## Dados temporalmente consistentes

Os dados podem conter falhas temporais. Isso implica que podem haver saltos temporais nos dados. Para garantir que os dados fiquem consitentes temporal (cada estação com dias contendo 24 horas e anos com 365 ou 366 dias) faz-se o preenchimento dos horários faltantes com as datas adequadas e os valores das variáveis recebem `NA`.

```{#r, eval=TRUE}
# Verificando intervalo de tempo 
time_step <- data_mod %>%
  filter(., site == "A801") %>%
  select(date) %$%
  get_interval(date)
time_step

nrow(data_mod)
```

```{#r} 
# Cada site com um perído de dados diferente

## table(data_mod$site)

data_pad <-
  data_mod %>%
  filter(!is.na(date)) %>%
  complete_dates(group = "site", time_step = "hours") %>% 
  arrange(site) %>% 
  select(site, date, everything())

## nrow(data_pad)

rm(data_mod)
```

```{#r save_s04}
saveRDS(data_pad, '/home/jonas/Documents/GITHUB/jbc-ic/data_saves/s04_data_pad.rds')

rm(data_pad)
```

```{r load_s04}
data_pad <- readRDS('/home/jonas/Documents/GITHUB/jbc-ic/data_saves/s04_data_pad.rds')
data_pad
```

```{###r correcao}
# Correção do erro, dias/meses perdidos

tar_periods <- data_pad %>%
  group_by(site) %>%
  filter(!is.na(tavg)) %>%
  summarise(
    start = as.Date(min(date)), # data inicial
    end = as.Date(max(date)), # data final
    period = round(time_length(end - start, unit = "year"), 1))  %>% # período
  # desagrupando por site
  ungroup() %>%
  arrange(desc(period))
tar_periods %>% select(site, start) %>% arrange(site)
summary_91 %>% select(site, start) %>% arrange(site)
```

```{#r summary_pad}
temp.summary(
  DATA = data_pad,
  INFO = info,
  TYPE = "PAD",
  HOUSES = 5,
  SAVE = T,
  DIRECTORY = '/home/jonas/Documents/GITHUB/jbc-ic/data_saves/summary_pad.rds'
)
```

```{#r}
# Seleção das variáveis que queremos utilizar
data_var <-
  data_pad %>%
  select(site:tdmax, p, prec, rg)
data_var

rm(data_pad)
```

```{#r save_s05}
saveRDS(data_var, '/home/jonas/Documents/GITHUB/jbc-ic/data_saves/s05_data_var.rds')
rm(data_var)
```

```{r load_s05}
data_var <- readRDS('/home/jonas/Documents/GITHUB/jbc-ic/data_saves/s05_data_var.rds')
data_var
```

## Seleção de EMAs

### Critério de disponibilidade mínima de observações

Antes de determinar o período de dados de cada EMA é preciso remover as EMAs que conhenham muitos (todos) dados faltantes. Isso geralmente ocorre para EMAs inseridas recentemente no conjunto de dados. 

- Classificação das EMAs pela % de falhas

```{#r}
# Ranking de falhas das EMAs

rank_falt <-
  data_var %>%
  group_by(site) %>%
  summarise(
    N = n(),
    falt = sum(is.na(tavg)), 
    falt_perc = pctg(falt, N, 6)) %>%
  left_join(select(info, site, name), by = "site") %>% 
  
# combinando com info para saber nome das EMAs
##  full_join(info_old, by = "site") %>% 
  select(site, name, everything()) %>%
  arrange(desc(falt_perc))
rank_falt
```

Removendo EMAs sem dados.

```{#r}
# Dados preenchidos e informativo

not_informative <-
  rank_falt %>%
  filter(N == falt)
not_informative

data_inf <-
  data_var %>%
  filter(!site %in% not_informative$site)
data_inf

rm(rank_falt, not_informative)
rm(data_var)

### Nota: Como não houve caso de EMAs não informativas, "data_inf" será igual ao "data_var"
```

```{#r save_s06}
saveRDS(data_inf, '/home/jonas/Documents/GITHUB/jbc-ic/data_saves/s06_data_inf.rds')
rm(data_inf)
```

```{r load_s06}
data_inf <- readRDS('/home/jonas/Documents/GITHUB/jbc-ic/data_saves/s06_data_inf.rds')
data_inf
```

### Critérios baseados no período de dados

#### Seleção de dados por período mínimo e ano inicial

As EMAs selecionadas devem ter um período de pelo menos 4 anos e baseado em trabalhos prévios devem começar em 2008.

```{#r}
begin_year <- 2008
end_year <- 2016
minimum_time <- 4
```

```{#r}
data_year <-
  data_inf %>%
  openair::selectByDate(year = begin_year:end_year) %>%
  arrange(site) %>%
  select(site, date, everything())

rm(data_inf)
```

```{#r save_s07}
saveRDS(data_year, '/home/jonas/Documents/GITHUB/jbc-ic/data_saves/s07_data_year.rds')
rm(data_year)
```

```{r load_s07}
data_year <- readRDS('/home/jonas/Documents/GITHUB/jbc-ic/data_saves/s07_data_year.rds')
data_year
```

```{#r summary_year}
temp.summary(
  DATA = data_year,
  INFO = info,
  TYPE = "YEAR",
  HOUSES = 5,
  SAVE = T,
  DIRECTORY = '/home/jonas/Documents/GITHUB/jbc-ic/data_saves/summary_year.rds'
)
```

```{#r}
# Sites das EMAs com pelo menos 4 anos de dados
sel_sites <-
  summary_new %>%
  select(site) %>%
  pull() # transforma uma coluna de um data frame em um vetor

# Total de sites selecionados
length(sel_sites)

# Filtragem de EMAs com no mínimo 4 anos de dados
data_sel <-
  filter(data_year, site %in% sel_sites) %>%
  arrange(site) %>% 
  select(site, everything())

rm(sel_sites)
rm(data_year)
```

```{#r save_s08}
saveRDS(data_sel, '/home/jonas/Documents/GITHUB/jbc-ic/data_saves/s08_data_sel.rds')
rm(data_sel)
```

```{r load_s08}
data_sel <- readRDS('/home/jonas/Documents/GITHUB/jbc-ic/data_saves/s08_data_sel.rds')
data_sel
```

```{#r summary_91}

sum1 <- readRDS('/home/jonas/Documents/GITHUB/jbc-ic/data_saves/summary_mod.rds') %>%
  select(site:MOD_total, MOD_valid_tavg, MOD_pctg_valid_tavg)

sum2 <- readRDS('/home/jonas/Documents/GITHUB/jbc-ic/data_saves/summary_pad.rds') %>% 
  select(site, PAD_total, PAD_valid_tavg, PAD_pctg_valid_tavg)

sum3 <- readRDS('/home/jonas/Documents/GITHUB/jbc-ic/data_saves/summary_year.rds') %>% 
  select(site, YEAR_total, YEAR_valid_tavg, YEAR_pctg_valid_tavg)

sum23 <- full_join(sum2, sum3, by = "site")

summary_91 <- full_join(sum1, sum23) %>% arrange(start, site)

rm(sum1, sum2, sum3, sum23)
```

```{#r save_summary_91}
saveRDS(summary_91, '/home/jonas/Documents/GITHUB/jbc-ic/data_saves/summary_91.rds')
rm(summary_91)
```

```{r load_summary_91}
summary_91 <- readRDS('/home/jonas/Documents/GITHUB/jbc-ic/data_saves/summary_91.rds')
summary_91
```

```{#r summary_80}
summary_80 <- summary_91 %>% filter(period >= minimum_time)
rm(summary_91)
```

```{#r save_summary_80}
saveRDS(summary_80, '/home/jonas/Documents/GITHUB/jbc-ic/data_saves/summary_80.rds')

rm(summary_80)
```

```{r load_summary_80}
summary_80 <- readRDS('/home/jonas/Documents/GITHUB/jbc-ic/data_saves/summary_80.rds')
summary_80
```

# PARTE 2

## Mapas e Gráficos

```{r}
source("/home/jonas/Documents/GITHUB/jbc-ic/R/grama_phps.R")
```

```{r}
estados <- readRDS("/home/jonas/Documents/GITHUB/jbc-ic/data_saves/south_states.rds")
```

## Período

```{r, fig.width=9.3, fig.height=7.25, fig.align='center' }
gg_period <- simple.bubble(
  data = summary_91,
  variable = 'period',
  limits = estados,
  legend = 'Período (em anos)',
  title = "Período de dados das 91 EMAs do INMET")
gg_period
```

```{r}
ggplot(summary_new, aes(x = round(period))) + 
  #geom_histogram(aes(y = ..count../sum(..count..)), stat = "count") + 
  geom_histogram(stat = "count", aes(fill = state)) +
  #viridis::scale_fill_viridis(discrete=TRUE, option = "inferno") +
  scale_fill_grey() +
#  scale_y_continuous(labels = scales::percent, sec.axis = sec_axis(~. * sum(.))) + 
  scale_x_continuous(breaks = scales::pretty_breaks(n = 15), expand = c(0, 0)) +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 12), expand = c(0.05, 0.05)) +
  labs(x = "Período (anos)", y = "Nº de EMAs") +
  theme_bw()
```

## Disponibilidade de dados

```{r}
gap <-
  data_sel %>%
  group_by(site) %>%
  dplyr::summarise(
# % de dados faltantes
    tavg_valid = pctg_NA(var = tavg, houses = 1, valid = T),
    missing = pctg_NA(var = tavg, houses = 1),
    long_valid = longest_gap(tavg, reverse = TRUE),
# tamanho da falha mais longa
    long_gap = longest_gap(tavg),
# data de início da maior falha
    sdate_lv = date_longest_gap(tavg, date, reverse = TRUE),
    sdate_lg = date_longest_gap(tavg, date) ) %>%
# desagrupando por site
  ungroup() %>%
# combinando com a tabela de informações das EMA
  left_join(summary_new, by = "site") %>%
  select(site, state, name, period, everything()) %>% 
#  arrange_vars(c("name" = 2, "period" = 3)) %>%
  arrange(desc(missing))
gap
```


```{r, fig.width=9.3, fig.height=7.25, fig.align='center' }
gg_valid <- simple.bubble(
  data = summary_80,
  variable = 'YEAR_pctg_valid_tavg',
  limits = estados,
  legend = 'Dados Válidos (em %)',
  title = "Disponibilidade de dados das 80 EMAs do INMET selecionadas")
gg_valid
```

```{#r}
BD_data_pad <- JC.scripts::Break.Dates(
  DATA = data_pad, VAR = "date", YEAR = T, MONTH = T,DAY = T, HOUR = T)
BD_data_pad

saveRDS(BD_data_pad, "/home/jonas/Documents/GITHUB/jbc-ic/data_saves/BD_data_pad.rds")
rm(BD_data_pad)
```


```{r}
data_pad <- readRDS('/home/jonas/Documents/GITHUB/jbc-ic/data_saves/s04_data_pad.rds')

records_month <-
  data_pad %>%
  select(date, site, tavg) %>%
  group_by(site, format(date, "%m")) %>%
  openair::timeAverage(
    avg.time = "month", statistic = "data.cap", type = "site") %>%
  ungroup()

saveRDS(records_month, "/home/jonas/Documents/GITHUB/jbc-ic/data_saves/PAD_records_month.rds")

rm(data_pad, records_month)

records_month <- readRDS("/home/jonas/Documents/GITHUB/jbc-ic/data_saves/PAD_records_month.rds")
records_month
```




